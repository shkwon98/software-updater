<?xml version="1.0" encoding="UTF-8"?>
<root BTCPP_format="4" main_tree_to_execute="MainTree">

    <BehaviorTree ID="MainTree">
        <Sequence>
            <SubTree ID="WaitForUpdateRequest" received_path="{search_path}"/>
            <SubTree ID="CopyAndExtractPackage" where_to_find="{search_path}" package_regex="copilot_*.*.*.tar.gz"/>
            <RetryUntilSuccessful num_attempts="10">
                <SubTree ID="InstallPackage"/>
            </RetryUntilSuccessful>
        </Sequence>
    </BehaviorTree>

    <BehaviorTree ID="WaitForUpdateRequest">
        <IfThenElse>
            <Sleep msec="3000"/>
            <SetBlackboard value="./" output_key="received_path"/>
        </IfThenElse>
    </BehaviorTree>

    <BehaviorTree ID="CopyAndExtractPackage">
        <Sequence>
            <FindFile path="{where_to_find}" expression="{package_regex}" files="{candidate_pkgs}"/>
            <FindLatestPackage files="{candidate_pkgs}" file="{original_pkg}"/>
            <CopyFile src="{original_pkg}" dest="/tmp" output="{temporal_pkg}"/>
            <ExtractArchive file="{temporal_pkg}"/>
        </Sequence>
    </BehaviorTree>

    <BehaviorTree ID="InstallPackage">
        <SequenceWithMemory>
            <AlwaysSuccess/>
            <AlwaysSuccess/>
            <AlwaysFailure/>
        </SequenceWithMemory>
    </BehaviorTree>

    <!-- Description of Node Models (used by Groot) -->
    <TreeNodesModel>
        <Action ID="FindFile" editable="true">
            <input_port name="path"/>
            <input_port name="expression"/>
            <output_port name="files"/>
        </Action>
        <Action ID="FindLatestPackage" editable="true">
            <input_port name="files"/>
            <output_port name="file"/>
        </Action>
        <Action ID="CopyFile" editable="true">
            <input_port name="src"/>
            <input_port name="dest"/>
            <output_port name="output"/>
        </Action>
        <Action ID="ExtractArchive" editable="true">
            <input_port name="file"/>
            <output_port name="out_dir"/>
        </Action>
    </TreeNodesModel>

</root>
